/*
 * audio_fifo.c
 *
 *  Created on: Sep 10, 2019
 *      Author: Zach
 */

#include "dds_phase_accum.h"

#include <stdbool.h>

#include "xparameters.h"
#include "xgpio.h"
#include "fsl.h"


static bool dds_reset_gpio_initialized = false;
XGpio Gpio_dds_reset;

static void init_gpio(void) {
	int Status = XGpio_Initialize(&Gpio, XPAR_AXI_GPIO_DDS_RESETN_DEVICE_ID);

}

static uint32_t freq_to_accum(uint32_t freq_hz) {
	// phase_accum = (freq_hz * 2^27) / sample_rate
	const uint32_t c2p27 = 134217728;
	return (uint32_t) ((freq_hz * c2p27) / DDS_SAMPLE_RATE);
}

void set_dds_accum(uint32_t freq_hz) {
	uint32_t accum_val = freq_to_accum(freq_hz) >> 5; // only top 27 bits
	putfslx(accum_val, FSL_ID, FSL_DEFAULT);
	xil_printf("Frequency set to %luHz\r\n", freq_hz);
}

void reset_dds_phase(void) {
	if (!gpio_initialized) {
		init_gpio();
	}
}
